<!DOCTYPE html>
<html>
<head>
    <title>model</title>
    <style>
        html{
            overflow:hidden;
        }
        #canvas-frame {
            position:absolute;
            width: 100vw;
            height: 100vh;
        }
        #interaction{
            position:absolute;
            left:80vw;
            top:5vh;
            width: 20vw;
            height: 20vh;
            z-index: 10;
	        font-size: 30px;
        }
    </style>
</head>
<body>
    <div id="canvas-frame"></div>
    <!-- <div id="interaction">
        <p id="year"></p>
        <p id="screenNum"></p>
    </div> -->
	
    <script src="./static/js/support/three.js" ></script>
    <script src="./static/js/support/d3.v4.min.js"></script>
    
    <script src="./static/js/support/OrbitControls.js" ></script>
    <script src="./static/js/support/STLLoader.js" ></script>

    <script src="./static/js/objSelection.js"></script>
   
    <script type="text/javascript">

        var threeDiv = document.getElementById( 'canvas-frame' );
        var renderer = new THREE.WebGLRenderer( {antialias: true, alpha: true} );
        renderer.setClearColor( 0xffffff, 0 );

        var width = threeDiv.clientWidth;
        var height = threeDiv.clientHeight;
        renderer.setSize(width, height);
        threeDiv.appendChild(renderer.domElement);

        var scene = new THREE.Scene();

        var group = new THREE.Object3D();
        scene.add(this.group);

        scene.userData.element = threeDiv;

        var camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 10000);
        camera.position.x = 0;
        camera.position.y = 100;
        camera.position.z = 300;
        camera.lookAt(group.position);
        scene.add(camera);
        scene.userData.camera = camera;

        var light = new THREE.DirectionalLight(0xffffff, 1.0, 0);
        light.position.set(-100, 500, 200);
        scene.add(light);

        var aLight = new THREE.AmbientLight( 0xaaaaaa );
        scene.add( aLight );

        var orbitControls = new THREE.OrbitControls(scene.userData.camera, scene.userData.element);
        orbitControls.target = group.position;//控制焦点
        // orbitControls.autoRotate = true;//自动旋转
        scene.userData.controls = orbitControls;

        // initGrid();
        initObject();
        
        var object_selection;
        ObjectSelection();
        render();

        function initGrid(){
            //平面
            var gridXZ = new THREE.GridHelper(200, 10, 0xa23131, 0xa23131);//4个参数分别是：网格宽度、等分数、中心线颜色，网格线颜色
            gridXZ.position.set( 0,0,0 );
            gridXZ.material.linewidth = 10;
            scene.add(gridXZ);
        }


        function render()
        {
            scene.userData.controls.update();
            object_selection.render(group, scene.userData.camera);
            renderer.render(scene, scene.userData.camera);
            requestAnimationFrame(render);
        }

        function initObject(){
            // var loader = new THREE.STLLoader();
            // var that = this;
            // loader.load("./static/model/hand1.stl", 
            //     function (geometry) {
            //         //创建纹理
            //         console.log('模型');
            //         console.log('geometry:', geometry);

            //         var mat = new THREE.MeshPhongMaterial({color: 0xff0000});
            //         var mesh = new THREE.Mesh(geometry, mat);
            //         // mesh.rotation.x = -0.5 * Math.PI; //将模型摆正
            //         // mesh.scale.set(0.1, 0.1, 0.1); //缩放
            //         // geometry.center(); //居中显示
            //         that.scene.add(mesh);
            //         console.log(that.scene);
            //     },
            //     function(msg){console.log(msg)},
            //     function(err){console.log('错误：', err) }
            // );

            var loader = new THREE.STLLoader();
            var material = new THREE.MeshPhongMaterial( { color: 0xAA0000, specular: 0x111111, shininess: 200 } );


            // Colored binary STL
            loader.load( './static/model/stl/binary/hand1.stl', 
                function ( geometry ) {

                    var meshMaterial = material;
                    if ( geometry.hasColors ) {

                        meshMaterial = new THREE.MeshPhongMaterial( { opacity: geometry.alpha, vertexColors: THREE.VertexColors } );

                    }

                    var mesh = new THREE.Mesh( geometry, meshMaterial );

                    mesh.position.set( 0.5, 0.2, 0 );
                    mesh.rotation.set( - Math.PI / 2, Math.PI / 2, 0 );
                    mesh.scale.set( 0.3, 0.3, 0.3 );

                    mesh.castShadow = true;
                    mesh.receiveShadow = true;

                    scene.add( mesh );
                    console.log('模型加载完成');

                },
                function(msg){
                    console.log(msg);
                },
                function(err){
                    console.log(err);
                } 
            );


            loader.load( './static/model/stl/binary/pr2_head_tilt.stl', function ( geometry ) {

                    var mesh = new THREE.Mesh( geometry, material );

                    mesh.position.set( 0.136, - 0.37, - 0.6 );
                    mesh.rotation.set( - Math.PI / 2, 0.3, 0 );
                    mesh.scale.set( 2, 2, 2 );

                    mesh.castShadow = true;
                    mesh.receiveShadow = true;

                    scene.add( mesh );

                } );
        }

       
        function ObjectSelection(){
            object_selection = new THREE.ObjectSelection({//个人封装的js，three.js官方库中无
                domElement: scene.userData.element,//渲染区域
                selected: function(selectObj) {//selectObj为选取返回对象
                    // 显示信息，此处为个性化处理，该函数会作为传入objsel.js中作为处理函数
                    if(selectObj !== null) {//判断是否为空，objsel.js中有对应
                        var meshObj = selectObj.object;
                        meshObj.material.color = new THREE.Color("rgb(220,76,65)");

                        document.getElementById('year').textContent = meshObj.userData.name + ' 年度';
                        document.getElementById('screenNum').textContent = meshObj.userData.num +' 块屏';
                    }
                },
                clicked: function(selectObj) {//点击事件
                    if(selectObj !== null) {

                  }
                },
                mousedown: function(selectObj) {//点击事件
                    if(selectObj !== null) {
                        
                  }
                },
                mouseup: function(selectObj) {//点击事件
                   if(selectObj !== null) {
                        
                  }
                }
              });
        }
    </script>

</body>
</html>
