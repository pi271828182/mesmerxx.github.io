<!--除数据外都完整-->
<!DOCTYPE html>
<html>
<head>
    
    <title>class</title>
    <style>
        html{
            height: 100%;
            overflow:hidden;
            font-weight:100;
        }
        body {
            font-family: 'Roboto', sans-serif;
            font-size: 1em;
            height: 100%;
            margin: 0;
        }
        
        .content{
            float: left;
            width: 100%;
            height: 50%;
            z-index: 10;
            border-bottom:1px #000000 solid;
        }

        .list-item {
            display: inline-block;
            box-sizing: content-box;
            margin: 0;
            padding: 0;
            box-shadow: 1px 2px 4px 0px rgba(0,0,0,0.25);
            width:24.8%;
            height: 50vh;
			}
        .left{
            float: left;
            border-right:1px #000000 solid;
        }
        .right{
            float: right;
            border-left:1px #000000 solid;
        }

        #canvas-frame {
            position:absolute;
            /*top:10vh;*/
            left:12.5vw;
            width: 75vw;
            height: 99vh;
            z-index: 5;
        }
    </style>
    
</head>
<body>
    <div class="content">
        <div class="list-item left"></div>
        <div class="list-item left" id="g1"></div>
        <div class="list-item left" id="g2"></div>
        <div class="list-item option" id="g3"></div>
    </div>
    <div class="content">
        <div class="list-item left"></div>
        <div class="list-item left" id="g4"></div>
        <div class="list-item left" id="g5"></div>
        <div class="list-item nextCanvas" id="g6"></div>
    </div>

    <script src="./static/js/support/three.js" ></script>
    
    <script src="./static/js/support/OrbitControls.js" ></script>
    
    <script src="./static/js/support/STLLoader.js" ></script>

    <script src="./static/js/objSelection.js"></script>

    <script src="static/js/support/d3.v4.min.js"></script>
    
    <!-- <script src="static/js/viz3d.js?version=1"></script> -->
    <script type="text/javascript">
        class GraphThree{
            static scenes;
            scene;
            renderer;

            group;
            threeDiv;//dom对象
            data;//存放几何体数据，name, length, color
            object_selection;

            // #FFCF71 10%, #2376DD
            //d3.color('#5fc3e4'), d3.color('#e55d87')
            color = d3.interpolate(d3.color('#FFCF71'), d3.color('#2376DD'));//颜色插值函数，网页背景色
            isCatalog = false;

            constructor(data, renderDivId, isCatalog) {//对象和两个字符串
                this.isCatalog = isCatalog;
                this.threeDiv = document.getElementById( renderDivId );
                this.renderer = new THREE.WebGLRenderer( {antialias: true, alpha: true} );
                this.renderer.setClearColor( 0xffffff, 0 );

                var width = this.threeDiv.clientWidth;
                var height = this.threeDiv.clientHeight;
                this.renderer.setSize(width, height);
                this.threeDiv.appendChild(this.renderer.domElement);

                // GraphThree.scenes = new Array();
                this.scene = new THREE.Scene();
                // GraphThree.scenes.push(this.scene);

                this.group = new THREE.Object3D();
                this.scene.add(this.group);

                this.scene.userData.element = document.getElementById(renderDivId);

                var camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 10000);
                camera.position.x = 0;
                camera.position.y = 100;
                camera.position.z = 300;
                camera.lookAt(this.group.position);
                this.scene.add(camera);
                this.scene.userData.camera = camera;

                var light = new THREE.DirectionalLight(0xffffff, 1.0, 0);
                light.position.set(-100, 500, 200);
                this.scene.add(light);

                // var aLight = new THREE.AmbientLight( 0xaaaaaa ); // soft white light
                // this.scene.add( aLight );

                var orbitControls = new THREE.OrbitControls(this.scene.userData.camera, this.scene.userData.element);
                orbitControls.target = this.group.position;//控制焦点
                orbitControls.autoRotate = true;//自动旋转
                this.scene.userData.controls = orbitControls;

                this.data = data;
            }

            //光圈
            creatAureole(){
                //顶点着色器
                var vertexShader = [
                'varying vec3   vVertexWorldPosition;',
                'varying vec3   vVertexNormal;',
                'varying vec4   vFragColor;',
                'void main(){',
                '   vVertexNormal   = normalize(normalMatrix * normal);',//将法线转换到视图坐标系中
                '   vVertexWorldPosition    = (modelMatrix * vec4(position, 1.0)).xyz;',//将顶点转换到世界坐标系中
                '   // set gl_Position',
                '   gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);',
                '}'

            ].join('\n');
                //大气层效果
                THREE.AeroSphere = {
                    uniforms: {
                        coeficient: {
                            type: "f",
                            value: 1.0
                        },
                        power: {
                            type: "f",
                            value: 2
                        },
                        glowColor: {
                            type: "c",
                            value: new THREE.Color(0xfff5eb)
                        }
                    },
                    vertexShader: vertexShader,//顶点着色器
                    fragmentShader: [
                        'uniform vec3   glowColor;',
                        'uniform float  coeficient;',
                        'uniform float  power;',

                        'varying vec3   vVertexNormal;',
                        'varying vec3   vVertexWorldPosition;',

                        'varying vec4   vFragColor;',

                        'void main(){',
                        '   vec3 worldCameraToVertex= vVertexWorldPosition - cameraPosition;',  //世界坐标系中从相机位置到顶点位置的距离
                        '   vec3 viewCameraToVertex = (viewMatrix * vec4(worldCameraToVertex, 0.0)).xyz;',//视图坐标系中从相机位置到顶点位置的距离
                        '   viewCameraToVertex  = normalize(viewCameraToVertex);',//规一化
                        '   float intensity     = pow(coeficient + dot(vVertexNormal, viewCameraToVertex), power);',
                        '   gl_FragColor        = vec4(glowColor, intensity);',
                        '}'//vVertexNormal视图坐标系中点的法向量
                        //viewCameraToVertex视图坐标系中点到摄像机的距离向量
                        //dot点乘得到它们的夹角的cos值
                        //从中心向外面角度越来越小（从钝角到锐角）从cos函数也可以知道这个值由负变正，不透明度最终从低到高
                    ].join('\n')
                };
                //大气层
                var material1 = new THREE.ShaderMaterial({
                    uniforms: THREE.AeroSphere.uniforms,
                    vertexShader: THREE.AeroSphere.vertexShader,
                    fragmentShader: THREE.AeroSphere.fragmentShader,
                    blending: THREE.NormalBlending,
                    transparent: true,
                    depthWrite:false
                });
                var sphere = new THREE.SphereBufferGeometry(120, 32, 32);
                var mesh = new THREE.Mesh(sphere, material1);
                this.scene.add(mesh);
            }

            drawSVG(geo_data) {
                var that = this;
                var margin = 0,
                        width = 2048,
                        height = 1024;
                var svg = d3.select("#worldsvg")
                        .append("svg")
                        .attr("xmlns", "http://www.w3.org/2000/svg")
                        .attr("version", "1.1")
                        .attr("width", width + margin)
                        .attr("height", height + margin)
                var projection = d3.geoMercator()
                        .scale(200)
                        .translate([760, 470]);
                var path = d3.geoPath().projection(projection);
                var map = svg.selectAll('path')
                        .data(geo_data.features)
                        .enter()
                        .append('path')
                        .attr('d', path)
                        .attr('title', function (d) {
                            return d.properties.name;
                        })
                        .attr('id', function (d) {
                            return d.id;
                        })
                        .style('fill', function(d){
                            var countryColor;
                            if(filmNum[d.properties.name]){
                                var num = filmNum[d.properties.name];
                                if(num < 10){
                                    countryColor = that.color(0);
                                }
                                else if (num<100) {
                                    countryColor = that.color(0.15);
                                }
                                else if (num<500) {
                                    countryColor =that.color(0.3);
                                }
                                else if (num<1000) {
                                    countryColor =that.color(0.45);
                                }
                                else if (num<3000) {
                                    countryColor = that.color(0.6);
                                }
                                else if (num<5000) {
                                    countryColor = that.color(0.75);
                                }
                                else if (num<10000) {
                                    countryColor = that.color(0.9);
                                }
                                else{
                                    countryColor = that.color(1);
                                }
                            }
                            else{
                                countryColor = '#f4f9f4';
                            }
                            return countryColor;
                        })
                        .style('stroke', 'black')
                        .style('stroke-width', 0.4);
            }

            //加载纹理
            getTexture(str){//str为纹理url
                var loader = new THREE.TextureLoader();
                 return loader.load(str);
            }

            initGrid(){
                //平面
                var gridXZ = new THREE.GridHelper(200, 10, 0xa23131, 0xa23131);//4个参数分别是：网格宽度、等分数、中心线颜色，网格线颜色
                gridXZ.position.set( 0,0,0 );
                gridXZ.material.linewidth = 10;
                this.scene.add(gridXZ);
                if(this.isCatalog){
                    gridXZ.scale.set(0.6, 0.6, 0.6)
                }
            }
        }

        class Histogram extends GraphThree{
            constructor(data, threeDivId, isCatalog){
                super(data, threeDivId, isCatalog);
            }

            start(){
                this.initGrid();
                this.creatAureole();
                this.initObject();
                this.layout();
                this.ObjectSelection();
                this.render();
            }

            render() {
                this.scene.userData.controls.update();

                if(this.isCatalog == false){
                    this.object_selection.render(this.group, this.scene.userData.camera);
                }

                this.renderer.render(this.scene, this.scene.userData.camera);
                requestAnimationFrame(this.render.bind(this));//传递当前语境中的this
            }

            initObject(){
                var linear = d3.scaleLinear()
                                    .domain([10000, 70000])
                                    .range([0, 150]);
                for(var i in this.data) {
                    var material = new THREE.MeshBasicMaterial( {
                        color: this.color(linear(this.data[i].length)/150),
                        opacity: 1
                    });
                    var cylinder = new THREE.CylinderGeometry(10, 10, linear(this.data[i].length));
                    var mesh = new THREE.Mesh(cylinder, material);
                    mesh.userData.length = this.data[i].length;
                    mesh.material.wireframe = true;
                    mesh.userData.name = this.data[i].name;
                    mesh.userData.num = this.data[i].length;

                    this.group.add(mesh);

                    this.data[i].length = Math.ceil(linear(this.data[i].length));

                }
            }

            layout(){
                var objs = this.group.children;//数组

                var radius = 40;
                var angle = 0;
                var x, z;

                for(var i=0;i<objs.length; i++){
                    if (objs[i].type == 'Mesh'){
                        x = radius * Math.cos(angle);
                        z = radius * Math.sin(angle);
                        angle += Math.PI*2/this.data.length;
                        objs[i].position.set(x, this.data[i].length/2, z);//因为position在几何体中心
                    }
                }
            }

            ObjectSelection(){
                this.object_selection = new THREE.ObjectSelection({//个人封装的js，three.js官方库中无
                    domElement: this.scene.userData.element,//渲染区域
                    selected: function(selectObj) {//selectObj为选取返回对象
                      // 显示信息，此处为个性化处理，该函数会作为传入objsel.js中作为处理函数
                        if(selectObj !== null) {//判断是否为空，objsel.js中有对应
                            var meshObj = selectObj.object;
                            meshObj.material.color = new THREE.Color("rgb(220,76,65)");

                            document.getElementById('year').textContent = meshObj.userData.name + ' 年度';
                            document.getElementById('screenNum').textContent = meshObj.userData.num +' 块屏';
                      } else {
                        // delete info_text.select;//若无选择对象则删除显示变量等等
                      }
                    },
                    clicked: function(selectObj) {//点击事件
                        // obj.material.color.setHex( Math.random() * 0xe0e0e0 );
                    },
                    mousedown: function(selectObj) {//点击事件
                        // obj.material.color.setHex( Math.random() * 0xe0e0e0 );
                    },
                    mouseup: function(selectObj) {//点击事件
                        // obj.material.color.setHex( Math.random() * 0xe0e0e0 );
                    }
                  });
            }

        }

        class Model extends GraphThree{
            constructor(data, threeDivId, isCatalog){
                super(data, threeDivId, isCatalog);
                var light2 = new THREE.DirectionalLight(0xeeeeee, 1.0, 0);
                light2.position.set(500, 0, 0);
                this.scene.add(light2);

                var light3 = new THREE.DirectionalLight(0xeeeeee, 1.0, 0);
                light3.position.set(-500, 0, 0);
                this.scene.add(light3);
            }

            start(){
                // this.initGrid();
                this.creatAureole();
                this.initObject();
                
                this.ObjectSelection();
                this.render();
            }

            render() {
                this.scene.userData.controls.update();

                if(this.isCatalog == false){
                    this.object_selection.render(this.group, this.scene.userData.camera);
                }

                this.renderer.render(this.scene, this.scene.userData.camera);
                requestAnimationFrame(this.render.bind(this));//传递当前语境中的this
            }

            initObject(){
                var loader = new THREE.STLLoader();
                var material = new THREE.MeshPhongMaterial( { color: 0xffffff, specular: 0x111111, shininess: 200 } );


                // Colored binary STL
                loader.load( this.data, 
                    function ( geometry ) {

                        var meshMaterial = material;
                        if ( geometry.hasColors ) {

                            meshMaterial = new THREE.MeshPhongMaterial( { opacity: geometry.alpha, vertexColors: THREE.VertexColors } );

                        }

                        geometry.center();

                        var mesh = new THREE.Mesh( geometry, meshMaterial );

                        scene.userData.controls.target = mesh.position;//控制焦点
            

                        mesh.rotation.set( - Math.PI / 2, 0, 0 );
                        // mesh.scale.set( 0.5, 0.5, 0.5 );

                        mesh.castShadow = true;
                        mesh.receiveShadow = true;

                        // scene.add( mesh );
                        group.add(mesh);
                    }
                );
            }


            ObjectSelection(){
                this.object_selection = new THREE.ObjectSelection({//个人封装的js，three.js官方库中无
                    domElement: this.scene.userData.element,//渲染区域
                    selected: function(selectObj) {//selectObj为选取返回对象
                        if(selectObj !== null) {//判断是否为空，objsel.js中有对应
                            
                      } else {
                        
                      }
                    },
                    clicked: function(selectObj) {//点击事件
                        // obj.material.color.setHex( Math.random() * 0xe0e0e0 );
                    },
                    mousedown: function(selectObj) {//点击事件
                        // obj.material.color.setHex( Math.random() * 0xe0e0e0 );
                    },
                    mouseup: function(selectObj) {//点击事件
                        // obj.material.color.setHex( Math.random() * 0xe0e0e0 );
                    }
                  });
            }

        }

    </script>

    <script>
    var isCatalog = true;

    var histData = [{name:'2012', length: 13118},
                    {name:'2013', length: 18195},
                    {name:'2014', length: 23592},
                    {name:'2015', length: 31627},
                    {name:'2016', length: 41056}];
    var hist = new Histogram(histData, 'g1', isCatalog);
    hist.start();
    hist.group.scale.set(0.8, 0.8, 0.8);

    var hand = new Model('./static/model/stl/binary/hand1.stl', 'g2', isCatalog);
    hand.start();
    // hand.group.scale.set(0.7, 0.7, 0.7);

    </script>


</body>
</html>